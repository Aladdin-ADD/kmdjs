(function(n){function h(n,t,u){var f=i.createElement("script"),s;u&&(s=isFunction(u)?u(n):u,s&&(f.charset=s)),c(f,t,n),f.async=!0,f.src=n,o=f,e?r.insertBefore(f,e):r.appendChild(f),o=null}function c(n,t,i){function u(i){n.onload=n.onerror=n.onreadystatechange=null,v.debug||r.removeChild(n),n=null,t(i)}var f="onload"in n;f?(n.onload=u,n.onerror=function(){throw"bad request!__"+i+"  404 (Not Found) ";}):n.onreadystatechange=function(){/loaded|complete/.test(n.readyState)&&u()}}function l(n,t){var r,i;if(n.lastIndexOf)return n.lastIndexOf(t);for(r=t.length,i=n.length-1-r;i>-1;i--)if(t===n.substr(i,r))return i;return-1}var a="HelloKanvas",i=document,v={},r=i.head||i.getElementsByTagName("head")[0]||i.documentElement,e=r.getElementsByTagName("base")[0],o,u={},t;u.get=function(n,i){var f,e,o,u,r,s;for(typeof n=="string"&&(n=[n]),r=0,u=n.length;r<u;r++)l(n[r],".")==-1&&(n[r]=a+"."+n[r]);for(f=!0,e=[],r=0,u=n.length;r<u;r++)t.modules[n[r]]?e.push(t.modules[n[r]]):f=!1;if(f)i.apply(null,e);else for(o=0,u=n.length,r=0;r<u;r++)s=[],h(n[r]+".js",function(){if(o++,o==u){for(var r=0;r<u;r++)t.modules[n[r]]&&s.push(t.modules[n[r]]);i.apply(null,s)}})},u.exec=function(n){for(var r,f,e,u=0,o=n.length;u<o;u++){var i=n[u],s=[],h=new Function(i.a,i.b);for(r=0,f=i.d.length;r<f;r++)s.push(t.modules[i.d[r]]);e=h.apply(null,s),t.modules[i.c]=e}},n.kmdjs=u;var f=!1,y=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,s=function(){};s.extend=function(n){function i(){!f&&this.ctor&&this.ctor.apply(this,arguments)}var e=this.prototype,u,r,t;f=!0,u=new this,f=!1;for(t in n)t!="statics"&&(u[t]=typeof n[t]=="function"&&typeof e[t]=="function"&&y.test(n[t])?function(n,t){return function(){var r=this._super,i;return this._super=e[n],i=t.apply(this,arguments),this._super=r,i}}(t,n[t]):n[t]);for(r in this)this.hasOwnProperty(r)&&r!="extend"&&(i[r]=this[r]);if(n.statics)for(t in n.statics)t=="ctor"?n.statics[t].call(i):i[t]=n.statics[t];return i.prototype=u,i.prototype.constructor=i,i.extend=arguments.callee,i},n.__class=s,t={},t.modules={},n.__modules=t.modules,function(){var t={},n={};n.Shape={},n.Matrix2D=__class.extend({statics:{DEG_TO_RAD:.017453292519943295},ctor:function(n,t,i,r,u,f){return this.a=n==null?1:n,this.b=t||0,this.c=i||0,this.d=r==null?1:r,this.tx=u||0,this.ty=f||0,this},identity:function(){return this.a=this.d=1,this.b=this.c=this.tx=this.ty=0,this},appendTransform:function(t,i,r,u,f,e,o,s,h){if(f%360)var a=f*n.Matrix2D.DEG_TO_RAD,c=Math.cos(a),l=Math.sin(a);else c=1,l=0;return e||o?(e*=n.Matrix2D.DEG_TO_RAD,o*=n.Matrix2D.DEG_TO_RAD,this.append(Math.cos(o),Math.sin(o),-Math.sin(e),Math.cos(e),t,i),this.append(c*r,l*r,-l*u,c*u,0,0)):this.append(c*r,l*r,-l*u,c*u,t,i),(s||h)&&(this.tx-=s*this.a+h*this.c,this.ty-=s*this.b+h*this.d),this},append:function(n,t,i,r,u,f){var e=this.a,o=this.b,s=this.c,h=this.d;return this.a=n*e+t*s,this.b=n*o+t*h,this.c=i*e+r*s,this.d=i*o+r*h,this.tx=u*e+f*s+this.tx,this.ty=u*o+f*h+this.ty,this}}),n.Loader=__class.extend({ctor:function(){this.audios={},this.res={},this.loadedCount=0,this.resCount=-1,this.FILE_PATTERN=/(\w+:\/{2})?((?:\w+\.){2}\w+)?(\/?[\S]+\/|\/)?([\w\-%\.]+)(?:\.)(\w+)?(\?\S+)?/i,this.ns=3,this.sounds=[];for(var n=0;n<this.ns;n++)this.sounds.push([]);this.playing=[],this.soundsCount=0},get:function(n){return this.res[n]},loadRes:function(n){this.resCount=n.length;for(var t=0;t<n.length;t++)this._getTypeByExtension(n[t].src.match(this.FILE_PATTERN)[5])=="audio"?this.loadAudio(n[t].id,n[t].src):this.loadImage(n[t].id,n[t].src)},loadImage:function(n,t){var i=document.createElement("img"),r=this;i.onload=function(){r._handleLoad(this,n),i.onreadystatechange=null},i.onreadystatechange=function(){(i.readyState=="loaded"||i.readyState=="complete")&&(r._handleLoad(this,n),i.onload=null)},i.onerror=function(){},i.src=t},loadAudio:function(n,t){var i=document.createElement("audio"),r,u;i.autoplay=!1,this.res[n]=i,i.src=null,i.preload="auto",i.onerror=function(){},i.onstalled=function(){},r=this,u=function(){r.playing[n]=0;for(var i=0;i<r.ns;i++)r.sounds[i][n]=new Audio(t);r.loadedCount++,r.handleProgress(r.loadedCount,r.resCount),r._clean(this),this.removeEventListener&&this.removeEventListener("canplaythrough",u,!1),r.checkComplete()},i.addEventListener("canplaythrough",u,!1),i.src=t,i.load!=null&&i.load()},checkComplete:function(){this.loadedCount===this.resCount&&this.handleComplete()},complete:function(n){this.handleComplete=n},progress:function(n){this.handleProgress=n},playSound:function(n){this.sounds[this.playing[n]][n].play(),++this.playing[n],this.playing[n]>=this.ns&&(this.playing[n]=0)},_handleLoad:function(n,t){this._clean(n),this.res[t]=n,this.loadedCount++,this.handleProgress&&this.handleProgress(this.loadedCount,this.resCount),this.checkComplete()},_getTypeByExtension:function(n){switch(n){case"jpeg":case"jpg":case"gif":case"png":case"webp":case"bmp":return"img";case"ogg":case"mp3":case"wav":return"audio"}},_clean:function(n){n.onload=null,n.onstalled=null,n.onprogress=null,n.onerror=null}}),n.DisplayObject=__class.extend({ctor:function(){this.scaleX=this.scaleY=1,this.x=this.y=this.rotation=this.regX=this.regY=this.skewX=this.skewY=0,this._matrix=new n.Matrix2D,this.events={}},updateContext:function(n){var t=this._matrix.identity().appendTransform(this.x,this.y,this.scaleX,this.scaleY,this.rotation,this.skewX,this.skewY,this.regX,this.regY);n.transform(t.a,t.b,t.c,t.d,t.tx,t.ty)},on:function(n,t){this.events[n]||(this.events[n]=[]),this.events[n].push(t)},execEvent:function(n){var i=this.events[n.type],t,r;if(i)for(t=0,r=i.length;t<r;t++)i[t].call(this)}}),n.Bitmap=n.DisplayObject.extend({ctor:function(n){this._super(),this.img=n},draw:function(n){n.drawImage(this.img,0,0)}}),n.RAF=__class.extend({statics:{ctor:function(){var n=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(n){window.setTimeout(n,1e3/60)}}(),t=function(t,i){function f(){var e=(new Date).getTime(),o=e-u;o>=i&&(t.call(),u=(new Date).getTime()),r.value=n(f)}if(!window.requestAnimationFrame&&!window.webkitRequestAnimationFrame&&!(window.mozRequestAnimationFrame&&window.mozCancelRequestAnimationFrame)&&!window.oRequestAnimationFrame&&!window.msRequestAnimationFrame)return window.setInterval(t,i);var u=(new Date).getTime(),r={};return r.value=n(f),r},i=function(n){window.cancelAnimationFrame?window.cancelAnimationFrame(n.value):window.webkitCancelAnimationFrame?window.webkitCancelAnimationFrame(n.value):window.webkitCancelRequestAnimationFrame?window.webkitCancelRequestAnimationFrame(n.value):window.mozCancelRequestAnimationFrame?window.mozCancelRequestAnimationFrame(n.value):window.oCancelRequestAnimationFrame?window.oCancelRequestAnimationFrame(n.value):window.msCancelRequestAnimationFrame?window.msCancelRequestAnimationFrame(n.value):clearInterval(n)};this.requestInterval=t,this.clearRequestInterval=i}}}),n.Sprite=n.DisplayObject.extend({ctor:function(t){this._super(),this.option=t,this.currentFrameIndex=0,this.animationFrameIndex=0,this.currentAnimation="walk",this._rect=[0,0,10,10],this.img=this.option.imgs[0];var i=this;this.loop=n.RAF.requestInterval(function(){var n=i.option,t=n.animations[i.currentAnimation].frames,r=t.length;i.animationFrameIndex++,i.animationFrameIndex>r-1&&(i.animationFrameIndex=0),i._rect=n.frames[t[i.animationFrameIndex]],i._rect.length>4&&(i.img=n.imgs[i._rect[4]])},1e3/this.option.framerate)},draw:function(n){n.drawImage(this.img,this._rect[0],this._rect[1],this._rect[2],this._rect[3],0,0,this._rect[2],this._rect[3])}}),n.Container=n.DisplayObject.extend({ctor:function(){this._super(),this.children=[]},draw:function(n){for(var i,t=0,r=this.children.length;t<r;t++)i=this.children[t],n.save(),i.updateContext(n),i.draw(n),n.restore()},add:function(n){arguments.length>1?this.children.push.apply(this.children,Array.prototype.slice.call(arguments)):this.children.push(n)},_getHitChild:function(n,t,i){var f=this.children.length,r,u;for(n.clearRect(0,0,n.canvas.width,n.canvas.height),r=f-1;r>=0;r--)if(u=this.children[r],n.save(),u.updateContext(n),u.draw(n),n.restore(),n.getImageData(t,i,1,1).data[3]>1)return u}}),n.Stage=n.Container.extend({ctor:function(n){this._super(),this.canvas=typeof n=="string"?document.querySelector(n):n,this.ctx=this.canvas.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height,this.hitCanvas=document.createElement("canvas"),this.hitCanvas.width=this.width,this.hitCanvas.height=this.height,this.hitCtx=this.hitCanvas.getContext("2d"),Function.prototype.bind=function(){var t=this,n=Array.prototype.slice.call(arguments),i=n.shift();return function(){return t.apply(i,n.concat(Array.prototype.slice.call(arguments)))}},this.canvas.addEventListener("click",this._handleClick.bind(this),!1),this.offset=this._getXY(this.canvas)},update:function(){this.ctx.clearRect(0,0,this.width,this.height),this.draw(this.ctx)},_handleClick:function(n){var t=this._getHitChild(this.hitCtx,n.pageX-this.offset[0],n.pageY-this.offset[1]);t&&t.execEvent(n)},_getClientXY:function(n){var i=0,r=0,t;if(n)if(document.documentElement.getBoundingClientRect&&n.getBoundingClientRect){t={left:0,top:0,right:0,bottom:0};try{t=n.getBoundingClientRect(),r=t.left,i=t.top}catch(u){return alert(1),[0,0]}}else while(n.offsetParent)i+=n.offsetTop,r+=n.offsetLeft,n=n.offsetParent;return[r,i]},_getXY:function(n){var t=this._getClientXY(n);return t[0]=t[0]+this._getScrollLeft(),t[1]=t[1]+this._getScrollTop(),t},_getScrollLeft:function(n){var t;return t=n?n.scrollLeft:Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),t||0},_getScrollTop:function(n){var t;return t=n?n.scrollTop:Math.max(document.documentElement.scrollTop,document.body.scrollTop),t||0}}),n.Txt=n.DisplayObject.extend({ctor:function(n,t,i){this._super(),this.text=n,this.font=t,this.color=i,this.textAlign="left",this.textBaseline="top"},draw:function(n){n.fillStyle=this.color,n.font=this.font,n.textAlign=this.textAlign||"left",n.textBaseline=this.textBaseline||"top",n.fillText(this.text,0,0)}}),n.Shape.Circle=n.DisplayObject.extend({ctor:function(n,t,i){this._super(),this.r=n||1,this.color=t||"black",this.isHollow=i},draw:function(n){n.beginPath(),n.arc(this.x,this.y,this.r,0,Math.PI*2),this.isHollow?(n.strokeStyle=this.color,n.stroke()):(n.fillStyle=this.color,n.fill())}}),t.Main=__class.extend({ctor:function(){var u=new n.Loader,r,t,i,h,e,o,s,c,f,a,l;u.loadRes([{id:"kmd",src:"img/kmd.png"},{id:"pig",src:"img/pig.png"},{id:"hero",src:"img/hero-m.png"}]),u.complete(function(){var i=new n.Bitmap(u.get("kmd")),e,f;i.x=100,i.y=100,t.add(i),r=new n.Bitmap(u.get("pig")),r.x=164,r.y=334,r.regX=64,r.regY=64,t.add(r);r.on("click",function(){alert("i am a pig")});e={framerate:10,imgs:[u.get("hero"),u.get("pig")],frames:[[64,64,64,64],[128,64,64,64],[192,64,64,64],[256,64,64,64],[320,64,64,64],[384,64,64,64],[448,64,64,64]],animations:{walk:{frames:[0,1,2,3,4,5,6],next:"run",speed:2,loop:!1},jump:{}}},f=new n.Sprite(e),f.y=200,t.add(f)}),t=new n.Stage("#ourCanvas"),i=new n.Txt("Hello Kanvas!","bold 36px Arial","green"),i.x=140,i.y=100,i.regX=100,i.regY=20,i.skewX=30,i.skewY=-30,i.rotation=20,t.add(i),t.update(),h=new n.Txt("KMD:Kill AMD and CMD!","bold 26px Arial","red"),h.y=400;h.on("click",function(){alert(this.text)});e=new n.Txt("Click Me!","bold 46px Arial","blue"),e.y=230,e.x=50;e.on("click",function(){alert(this.text)});t.add(h,e),o=new n.Shape.Circle(55,"red"),o.x=30,o.y=30;o.on("click",function(){alert("i'm a red ball!")});s=new n.Shape.Circle(35,"green"),s.x=30,s.y=30;s.on("click",function(){alert("i'm a green ball!")});c=new n.Shape.Circle(18,"yellow"),c.x=30,c.y=30,t.add(o,s,c),f=new n.Container,f.x=268,f.y=58,a=new n.Shape.Circle(48,"#777777"),l=new n.Txt("Container!","bold 16px Arial","white"),l.regX=40,l.regY=8,f.add(a,l),t.add(f);f.on("click",function(){alert("i am a Container!")});n.RAF.requestInterval(function(){i.rotation++,r&&r.rotation--,t.update()},15)}}),new t.Main}()})(this)